'use strict';

/**
 * @typedef {Object} ColorSupport
 * @property {number} level - The color support level (0=none, 1=basic, 2=256, 3=16m).
 * @property {boolean} hasBasic - Supports basic 16 colors.
 * @property {boolean} has256 - Supports 256 colors.
 * @property {boolean} has16m - Supports 16 million (TrueColor) colors.
 */

const { env, argv, platform, versions } = process;

// -- Helpers --

/**
 * Checks if a specific flag is present in argv.
 * @param {string} flag
 * @returns {boolean}
 */
const hasFlag = (flag) => {
	const prefix = flag.startsWith('-') ? '' : (flag.length === 1 ? '-' : '--');
	const position = argv.indexOf(prefix + flag);
	const terminatorPos = argv.indexOf('--');
	return position !== -1 && (terminatorPos === -1 || position < terminatorPos);
};

/**
 * transforms the integer level into a rich object.
 * @param {number} level
 * @returns {ColorSupport|false}
 */
const translateLevel = (level) => {
	if (level === 0) return false;
	return {
		level,
		hasBasic: true,
		has256: level >= 2,
		has16m: level >= 3
	};
};

/**
 * Detects the forcing of colors via environment variables or flags.
 * @returns {number|undefined}
 */
const getForceColor = () => {
	if (hasFlag('no-color') || hasFlag('no-colors') || hasFlag('color=false') || hasFlag('color=never')) {
		return 0;
	}

	if (hasFlag('color=16m') || hasFlag('color=full') || hasFlag('color=truecolor')) {
		return 3;
	}

	if (hasFlag('color=256')) {
		return 2;
	}

	if (hasFlag('color') || hasFlag('colors') || hasFlag('color=true') || hasFlag('color=always')) {
		return 1;
	}

	if ('FORCE_COLOR' in env) {
		if (env.FORCE_COLOR === 'true') return 1;
		if (env.FORCE_COLOR === 'false') return 0;
		return env.FORCE_COLOR.length === 0 ? 1 : Math.min(parseInt(env.FORCE_COLOR, 10), 3);
	}

	return undefined;
};

// -- Main Logic --

/**
 * detailed color support detection.
 * @param {import('tty').WriteStream} [stream]
 * @returns {number}
 */
const detectLevel = (stream) => {
	const forced = getForceColor();
	if (forced !== undefined) {
		return forced;
	}

	if (stream && !stream.isTTY) {
		return 0;
	}

	// 1. MinTTY (Git Bash, Cygwin)
	if (env.TERM === 'dumb') {
		return 0;
	}

	// 2. Windows System Detection
	if (platform === 'win32') {
		// Windows 10 build 10586 is the first release that supports 256 colors.
		// Windows 10 build 14931 is the first release that supports 16m/TrueColor.
		const osRelease = (require('os').release() || '').split('.');
		if (Number(osRelease[0]) >= 10 && Number(osRelease[2]) >= 10586) {
			return Number(osRelease[2]) >= 14931 ? 3 : 2;
		}
		return 1;
	}

	// 3. CI Environments
	if ('CI' in env) {
		if (['TRAVIS', 'CIRCLECI', 'APPVEYOR', 'GITLAB_CI', 'GITHUB_ACTIONS', 'BUILDKITE'].some(sign => sign in env) || env.CI_NAME === 'codeship') {
			return 1;
		}
		return 0;
	}

	// 4. TeamCity
	if ('TEAMCITY_VERSION' in env) {
		return /^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(env.TEAMCITY_VERSION) ? 1 : 0;
	}

	// 5. TrueColor Support (Standard)
	if (env.COLORTERM === 'truecolor' || env.COLORTERM === '24bit') {
		return 3;
	}

	// 6. Terminal Programs
	if ('TERM_PROGRAM' in env) {
		const version = parseInt((env.TERM_PROGRAM_VERSION || '').split('.')[0], 10);

		switch (env.TERM_PROGRAM) {
			case 'iTerm.app':
				return version >= 3 ? 3 : 2;
			case 'Apple_Terminal':
				return 2;
			case 'vscode': // Visual Studio Code
				return 3;
		}
	}

	// 7. Regex Term Sniffing
	if (/-256(color)?$/i.test(env.TERM)) {
		return 2;
	}

	if (/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(env.TERM)) {
		return 1;
	}

	if ('COLORTERM' in env) {
		return 1;
	}

	return 0;
};

/**
 * Public function to get support level.
 * @param {import('tty').WriteStream} [stream]
 */
function getSupportLevel(stream) {
	const level = detectLevel(stream);
	return translateLevel(level);
}

module.exports = {
	supportsColor: getSupportLevel,
	stdout: getSupportLevel(process.stdout),
	stderr: getSupportLevel(process.stderr)
};
